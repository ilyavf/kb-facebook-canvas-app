"use strict";angular.module("myappApp",["ngRoute","angularFileUpload","firebase"]).config(["$routeProvider",function(a){a.when("/",{controller:"InitCtrl",templateUrl:"views/init.html"}).when("/init/:ctrl/:action",{controller:"InitCtrl",templateUrl:"views/init.html"}).when("/init/:ctrl*",{controller:"InitCtrl",templateUrl:"views/init.html"}).when("/step1",{controller:"Step1Ctrl",templateUrl:"views/step1.html"}).when("/step2",{controller:"Step2Ctrl",templateUrl:"views/step2.html"}).when("/step3",{controller:"Step3Ctrl",templateUrl:"views/step3.html"}).when("/step4",{controller:"Step4Ctrl",templateUrl:"views/step4.html"}).when("/step5",{controller:"Step5Ctrl",templateUrl:"views/step_final.html"}).when("/receiver/:requestId",{controller:"Receiverstep1Ctrl",templateUrl:"views/receiver_step1.html"})}]),angular.module("myappApp").factory("CurrentUser",["$q","$rootScope","GetUser","$firebase",function(a,b,c,d){function e(a){FB.login(function(b){b.authResponse?(console.log("Welcome!  Fetching your information.... "),f(a)):console.log("User cancelled login or did not fully authorize.")},{scope:"user_friends,user_photos,publish_stream"})}function f(a){FB.api("/me?fields=name,username,relationship_status,significant_other",function(e){console.log("[fb_getMyInfo]: FB.api/me - Current user: "+e.name+".",e),a.info.id=e.id,a.info.name=e.name||"",a.info.username=e.username||"",a.info.relationship_status=e.relationship_status||"",a.info.spouse=e.significant_other||"",a.$fire=d(c(a.info.id)),a.$fire.$on("loaded",function(c){console.log("[fb_getMyInfo] firebase user data loaded: ",c),a.$fire.$child("info").$set(a.info),b.$apply(function(){console.log("- resolving loginStatusDeferred to TRUE..."),h.resolve(!0)})})})}var g="203880539796100",h=a.defer(),i={initialized:!1,loginStatus:h.promise,info:{id:null,name:null,username:null,relationship:"myself"},$fire:null};return console.log("FB init..."),FB.init({appId:g}),console.log("FB getLoginStatus..."),FB.getLoginStatus(function(a){console.log(a),a&&"connected"===a.status?(console.log("Already connected with FB"),f(i)):(console.log("Not logged in. Logging in to Facebook..."),e(i))}),console.log("[factory.CurrentUser]: "+angular.toJson(i)),window.CurrentUser=i,i}]),angular.module("myappApp").factory("FacebookFriends",["$q","ExtendFacebookFriends","CurrentUser",function(a,b,c){console.log("[FacebookFriends] init");var d=a.defer();return FB.api("/fql",{q:{all_friends:"SELECT name, username, uid FROM user WHERE uid IN (SELECT uid1 FROM friend WHERE uid2=me())",family_members:"SELECT uid, relationship FROM family WHERE profile_id = me()"}},function(a){if(a.error)console.log("*** ERROR *** Cannot retrieve Facebook friends. FB ERROR: "+a.error.message);else{var e=_.where(a.data,{name:"all_friends"})[0].fql_result_set,f=_.where(a.data,{name:"family_members"})[0].fql_result_set,g=c.info.spouse,h=b(e);if(_.each(f,function(a){var b=_.where(h,{id:a.uid})[0];b&&(b.relationship=a.relationship)}),g){var i=_.where(h,{id:g})[0];i&&(i.relationship="spouse")}console.log("All friends: "+h.length),d.resolve(h)}}),d.promise}]),angular.module("myappApp").factory("FacebookTagFriends",["$q","ExtendFacebookFriends",function(a,b){console.log("[FacebookTagFriends] init");var c=a.defer();return FB.api("/fql",{q:"SELECT name, username, uid FROM user WHERE uid IN (SELECT uid1 FROM friend WHERE uid2=me() and uid1 IN (SELECT owner FROM photo WHERE object_id IN (SELECT object_id FROM photo_tag WHERE subject = me())))"},function(a){var d=b(a.data);console.log("Relevant friends: "+d.length),c.resolve(d)}),c.promise}]),angular.module("myappApp").factory("ExtendFacebookFriends",function(){return function(a){return a.filter(function(a){return!!a.username}).map(function(a){return{id:a.uid||a.id,name:a.name,username:a.username,selected:!1,relationship:a.relationship||"friend"}})}}),angular.module("myappApp").factory("CloneFriends",["$rootScope","FacebookFriends","FacebookTagFriends",function(a,b,c){return console.log("[CloneFriends] init"),function(a,c,d){console.log("[CloneFriends] exec for "+a);var e=[],f=b;return c&&e.push(c),f.then(function(b){console.log("[CloneFriends] then for "+a+"("+d+")",b),_.each(b,function(a){e.push(_.clone(a))})}),e.reset=function(){_.each(this,function(a){a.selected=!1})},e}}]),angular.module("myappApp").factory("FriendObjects",["CloneFriends","CurrentUser",function(a,b){return a("FriendObjects",_.clone(b.info))}]),angular.module("myappApp").factory("FriendReceivers",["CloneFriends","CurrentUser",function(a,b){return a("FriendReceivers",_.clone(b.info),"RELEVANT_FRIENDS")}]),angular.module("myappApp").value("fireUsersUrl","https://kooboodle-fb-test.firebaseio.com/Users"),angular.module("myappApp").factory("GetUser",["fireUsersUrl",function(a){return function(b){return console.log("[Firebase.GetUser] "+a+"/"+b),new Firebase(a+"/"+b)}}]),angular.module("myappApp").factory("UserRequests",["CurrentUser",function(a){return a.$fire.$child("sent")}]),angular.module("myappApp").factory("SendRequest",["$http","$location",function(a,b){function c(a){var b={sender:a.sender,contacts:a.recipients.map(function(a){return{id:a.id,name:a.name,email:a.username+"@facebook.com"}}),subject:a.subject,type:a.type,message:a.message,photos:a.photos,app_url:h};return console.log("[SendRequest.formatData] data, formatted: ",a,b),angular.toJson(b)}var d=b.host(),e=b.protocol(),f="/cf/_fb/sendRequest.json",g=e+"://"+d+f,h=b.absUrl().slice(0,b.absUrl().indexOf("#"));return window.llocation=b,function(b){return a({method:"POST",url:g,data:c(b)})}}]),angular.module("myappApp").controller("InitCtrl",["$scope","$routeParams","$location","CurrentUser","requestObject",function(a,b,c,d,e){function f(a){var d=a&&a.received&&_.where(a.received,{status:"pending"});console.log("[InitCtrl.navigate]: data, pending:: "+b.ctrl+" "+b.action,a,d),d&&d.length>0?(console.log("- receiver flow"),console.log("- Go to Receiver"),"receiver"===b.ctrl&&b.action?(console.log("- /receiver/"+b.action),c.path("/receiver/"+b.action)):(console.log("- /receiver/last"),c.path("/receiver/last"))):(console.log("- regular flow. Loading..."),c.path("step1"))}return console.log("InitCtrl"),d.initialized?(console.log("- already initialized"),e.reset(),void c.path("/step1")):(d.initialized=!0,a.message="Connecting to Facebook...",void d.loginStatus.then(function(a){a===!0?(console.log("- logged in flow. CurrentUser.$fire.info: "+typeof d.$fire.info,d,d.$fire),d.$fire&&d.$fire.info?(console.log("- $fire.info is defined. Continue to the next step"),f(d.$fire)):(console.log("- $fire.info is NOT defined. Subscribing to firebase data load..."),d.$fire.$on("loaded",function(a){console.log("- firebase data gets loaded. Continuing to the next step"),f(a)}))):console.log("*** SYSTEM ERROR *** : loginStatus resolved with FALSE")}))}]),angular.module("myappApp").controller("EventCtrl",["$scope",function(a){a.$on("wizardActive",function(){console.log("[EventController] wizardActive"),a.$broadcast("wizardIsActive")}),a.$on("wizardInactive",function(){console.log("[EventController] wizardInactive"),a.$broadcast("wizardIsInactive")}),a.$on("changeFlow",function(b,c){console.log("[EventController.changeFlow] "+c),a.flow=c})}]),angular.module("myappApp").controller("UserrequestsCtrl",["$scope","$location","CurrentUser","SendReminder","FbServices",function(a,b,c,d,e){console.log("[UserrequestsCtrl]"),window.$location=b;var f=location.search.match(/requestsubject=([\w\s\-\+'",\.;]*)/);if(!c.initialized&&(f||"/"!==b.path()&&""!==b.path())){console.log("[UserrequestsCtrl] not initialized yet. Redirecting to init step..."+b.path());var g=f&&f[1],h=g?"/receiver/"+g:b.path();b.path("/init"+h)}a.currentRequestIndex=0,a.userdata=[],a.show=!1,a.$on("wizardIsActive",function(){console.log("[UserrequestsCtrl] wizardIsActive"),a.isVisible=!1}),a.$on("wizardIsInactive",function(){console.log("[UserrequestsCtrl] wizardIsInactive"),a.isVisible=!0}),a.showNextRequest=function(){a.currentRequestIndex++},a.countItems=function(a){return!!a&&_.keys(a).length},a.sendReminder=function(a,b){console.log("[sendReminder]",a,b),a.isLoading="loading",d(a,b).then(function(d){var f;try{f=JSON.parse(d.data.replace(/([^\}]*)$/g,""))}catch(g){console.log("*** Error *** unexpected answer from server",arguments)}f&&f.notification_sent&&0!==f.notification_sent.length?(a.isReminderSent=!0,a.date=(new Date).toJSON(),c.$fire.$save(),a.isLoading=""):e.requestMsg(a.id,b.id).then(function(b){"success"===b.status&&(a.isReminderSent=!0,a.date=(new Date).toJSON(),c.$fire.$save()),a.isLoading=""})})},a.isReminderVisible=function(a){return"pending"===a.status&&a.isReminderSent!==!0&&(!a.date||new Date(a.date).toDateString()!=(new Date).toDateString())},c.loginStatus.then(function(){a.userdata=c.$fire}),console.log("[UserrequestsCtrl] finished")}]),angular.module("myappApp").filter("emptyIfBlankOrSelected",function(){return function(a,b){var c=new RegExp(b,"i");return window.fObject=a,window.fQuery=b,window.fReg=c,_.filter(a,function(a){return b&&c.exec(a.name)||a.selected===!0})}}).filter("matchedOrSelected",function(){return function(a,b){var c=new RegExp(b,"i");return window.fObject=a,window.fQuery=b,window.fReg=c,_.filter(a,function(a){return c.exec(a.name)||a.selected===!0})}}),angular.module("myappApp").factory("SendReminder",["SendRequest","CurrentUser",function(a,b){return function(c,d){console.log("[SendRequest]",c,d);var e=a({sender:b.info,subject:d,message:"Reminder",recipients:[c]});return e}}]),angular.module("myappApp").service("requestObject",function(){this.subject,this.recipients,this.type,this.message,this.reset=function(){console.log("[requestObject.reset]",this),this.subject={name:"",id:null},this.recipients=[],this.type=null,this.message=null},this.reset()}),angular.module("myappApp").controller("Step1Ctrl",["$scope","requestObject",function(a,b){console.log("Step 1"),a.$emit("wizardInactive"),a.$emit("changeFlow","sender"),a.nav1State="active",a.isEventMsgShown=!1,a.setType=function(a){b.type=a}}]),angular.module("myappApp").controller("Step2Ctrl",["$scope","FriendObjects","requestObject",function(a,b,c){c.subject.name&&"friend"===c.type||(console.log("- resetting subject in friends array"),b.reset()),a.placeholderValue="friend"===c.type?"Your name or friend's name":'e.g. "Trip to France", "The Eiffel Tower", "Christmas"',a.placeholder=a.placeholderValue,a.hidePlaceholder=function(){a.placeholder=""},a.showPlaceholder=function(){a.placeholder=a.placeholderValue},a.subjectType=c.type,a.subjectEvent=c.subject,console.log("Step 2 "+c.type),a.friends=b,a.singleSelect=function(b){a.invalidInput="",angular.forEach(a.friends,function(a){a.selected=!1}),b.selected=!0,c.subject=b,c.subject.type="friend"},a.$emit("wizardActive"),a.nav1State="passed",a.nav2State="active",a.nextIfValid=function(b){if(console.log("Validation: "+a.subjectType+" "+a.subjectEvent),"event"===a.subjectType)if(a.subjectEvent.name.trim()){var d=a.subjectEvent.name.replace(/[^A-Za-z0-9_\-\s]/g,"");c.subject={name:d,id:d.replace(/\s/g,"+"),type:a.subjectType}}else c.subject=null;c.subject||(console.log("Validation error "+c.subject,c.subject),b.preventDefault(),a.invalidInput="animate-invalid-input")}}]),angular.module("myappApp").controller("Step3Ctrl",["$scope","$location","$window","FriendReceivers","requestObject","PrepareRequestData","SaveRequestData","SendRequest",function(a,b,c,d,e,f,g,h){e.recipients.length||(console.log("- resetting recipients in friends array",e),d.reset()),console.log("Step 3"),a.selectedSubject=e.subject.name,a.friends=d,a.placeholder="Filter",a.nav1State="passed",a.nav2State="passed",a.nav3State="active",a.nextBtnLoading=!1,a.nextIfValid=function(d){if(a.nextBtnLoading)return d.preventDefault(),console.log("... in process ..."),!1;if(a.save(),0===e.recipients.length)d.preventDefault(),a.invalidInput="animate-invalid-text";else{var i=f();if(0===i.recipients.length)return console.log("- all requests already sent"),void b.path("/step4");a.nextBtnLoading=!0,h({sender:i.currentUserInfo,subject:i.rsubject,type:"request",recipients:i.recipients}).then(function(c){var d;try{d=JSON.parse(c.data.replace(/([^\}]*)$/g,""))}catch(f){console.log("*** Error *** unexpected answer from server",arguments)}d&&d.notification_sent&&a.markUsers(e.recipients,d.notification_sent),g(i),console.log("[SendRequest promise resolved]",arguments),b.path("/step4")},function(b){console.log("*** ERROR *** failed to send FB requests",arguments),c.alert("System Error\n\nThere was an error while trying to send requests to Facebook.\n\nStatus: "+b.status+"\nMsg: "+b.data),a.nextBtnLoading=!1})}},a.clearValidation=function(){a.invalidInput=""},a.save=function(){e.recipients=_.where(d,{selected:!0})},a.markUsers=function(a,b){_.each(a,function(a){a.notification_sent=a.notification_sent||_.findWhere(b,{id:a.id})?!0:!1,a.isFbKooboodleUser=a.notification_sent}),console.log("Kooboodle users: "+a.filter(function(a){return a.isFbKooboodleUser}).map(function(a){return a.name}).join(", ")),console.log("NON Kooboodle users: "+a.filter(function(a){return!a.isFbKooboodleUser}).map(function(a){return a.name}).join(", "))}}]),angular.module("myappApp").controller("Step4Ctrl",["$scope","requestObject","FbServices",function(a,b,c){console.log("Step 4"),a.kbUsers=b.recipients.filter(function(a){return a.isFbKooboodleUser}),a.nonKbUsers=b.recipients.filter(function(a){return!a.isFbKooboodleUser}),a.kbUsersString=a.kbUsers.length>0&&a.kbUsers.map(function(a){return a.name}).join(", ").replace(/\,([^\,]*)$/," and $1"),a.nonKbUsersString=a.nonKbUsers.length>0&&a.nonKbUsers.map(function(a){return a.name}).join(", ").replace(/\,([^\,]*)$/," and $1"),a.selectedSubject=b.subject.name,a.done=a.nonKbUsers.length>0&&0===a.nonKbUsers.filter(function(a){return a.msgSent}).length?!1:!0,a.nextIfValid=function(b){return a.done?void 0:(b.preventDefault(),!1)},a.sendMessage=function(d){var e=b.recipients.filter(function(a){return a.id==d})[0];0==e.length||e.msgSent||c.requestMsg(d,b.subject.id).then(function(b){"success"===b.status&&(e.msgSent=!0,a.done=!0)})},a.nav1State="passed",a.nav2State="passed",a.nav3State="passed",a.nav4State="active"}]),angular.module("myappApp").controller("Step5Ctrl",["$scope","requestObject","$timeout",function(a,b){console.log("Step 5"),a.selectedSubject=b.subject.name,a.recipients=_.map(b.recipients,function(a){return a.name}).join(", ").replace(/\,([^\,]*)$/," and $1"),a.isValid=!0}]),angular.module("myappApp").controller("Receiverstep1Ctrl",["$scope","$routeParams","CurrentUser","$location","$upload","getAlbumId","GetPhotoUrlPromise","GetUser","SendRequest",function(a,b,c,d,e,f,g,h,i){a.$emit("changeFlow","receiver"),console.log("[Receiverstep1Ctrl]:"+b.requestId),a.isUploaderVisible=!1,a.$emit("wizardActive"),a.openUploader=function(){console.log("[openUploader clicked]"),a.isUploaderVisible=!0,document.getElementById("file-upload-input").click()},a.uploadedPhotos=[],a.isEventMsgShown=!1,a.showEventMsg=function(){a.isEventMsgShown=!a.isEventMsgShown};var j=_.where(c.$fire.received,{status:"pending"}),k=b.requestId&&_.filter(c.$fire.received,function(a){return a.subject.id==b.requestId})[0]||j[j.length-1];if(console.log("- # of pending requests: "+j.length),console.log("- processing request: "+k.subject.name),!k)return console.log("[Receiverstep1Ctrl] no pending requests found. Redirecting to init step..."),void d.path("/");if(a.senderName=k.sender.name,a.senderImgUrl="//graph.facebook.com/"+k.sender.username+"/picture",a.subjectName=k.subject.name,a.dialogPhotofinderIsHidden=!0,a.hideDialogPhotofinder=function(){a.dialogPhotofinderIsHidden=!0},a.showDialogPhotofinder=function(){a.dialogPhotofinderIsHidden=!1},a.notifyEmail={value:""},a.saveEmailAddress=function(){console.log("[Receiverstep1Ctrl.saveEmailAddress] "+a.notifyEmail.value),c.$fire.notifyEmail=a.notifyEmail.value,c.$fire.$save()},0===j.length)return console.log("WARNING: no pending requests found in ReceiverStep1"),void d.path("/");var l=f(k),m=h(k.sender.id).child("sent").child(k.subject.id).child("recipients").child(c.info.id);l.then(function(b){console.log("albumPromise resolved with:"+b.id,b);var d="https://graph.facebook.com/"+b.id+"/photos";console.log("uploadUrl = "+d),a.onFileSelect=function(f){a.loading="loading";for(var h=0,j=0;j<f.length;j++){var l=f[j];console.log("- file: ",l),function(j,l){console.log("- starting upload for "+j),a.upload=e.upload({url:d,withCredential:!0,data:{access_token:FB.getAccessToken()},file:l}).progress(function(){}).success(function(d){console.log(d),d.id&&g(d.id).then(function(b){console.log("Uploaded: "+j+", "+l.name),a.uploadedPhotos.push(b),h++,h===f.length&&(console.log("ALL files uploaded now"+h),a.loading="",i({sender:c.info,subject:k.subject,photos:h,recipients:[k.sender],type:"response"}).then(function(){console.log("[Receiverstep1Ctrl.sentPromise]: ",arguments)}))}),c.$fire.$child("received").$child(k.subject.id).$child("status").$set("completed"),m.child("status").set("completed"),m.child("albumInfo").set(b),m.child("date").set((new Date).toJSON()),m.child("photos").push({name:l.name,size:l.size,type:l.type,fbId:d.id})})}(j,l)}}})}]),angular.module("myappApp").factory("getAlbumId",["$q","CreateSharedAlbum","CurrentUser",function(a,b,c){var d=a.defer(),e=d.promise;return function(a){return a.albumInfo?d.resolve(a.albumInfo):b(a,function(b){d.resolve(b),a.albumInfo=b,c.$fire.$save()}),e}}]),angular.module("myappApp").factory("CreateSharedAlbum",function(){return function(a,b){var c=a.subject.name,d=a.sender.id,e=a.sender.name,f={name:"Photos of "+c+" (shared with "+e+")",privacy:{value:"CUSTOM",allow:d}};FB.api("/me/albums","post",f,function(a){console.log("FB me albums",f,a),a.id?FB.api("/"+a.id,function(a){b(a)}):console.log("ERROR: could not create an album: ",a)})}}),angular.module("myappApp").factory("GetPhotoUrlPromise",["$q",function(a){return function(b){var c=a.defer(),d=c.promise;return FB.api("/"+b,function(a){a.picture&&c.resolve(a.picture)}),d}}]),angular.module("myappApp").directive("kbDialogPhotofinder",function(){return{restrict:"E",templateUrl:"views/dialog_photofinder.html",scope:{close:"&onClose",action:"&onAction",notifyEmail:"=notifyEmail"},link:function(a){a.notifyIsVisible=!0,a.thankyouIsVisible=!1,a.notify=function(){a.action(),a.notifyIsVisible=!1,a.thankyouIsVisible=!0}}}}),angular.module("myappApp").service("PrepareRequestData",["CurrentUser","requestObject",function(a,b){return function(){var c=_.pick(a.info,"id","name","username"),d=[b.subject].map(function(a){var b={name:a.name,id:a.id,type:a.type};return a.relationship&&(b.relationship=a.relationship),b})[0],e=b.recipients.filter(function(a){return!a.notification_sent}).map(function(a){return{id:a.id,name:a.name,username:a.username,relationship:a.relationship}});return{currentUserInfo:c,rsubject:d,recipients:e}}}]),angular.module("myappApp").service("SaveRequestData",["CurrentUser","GetUser",function(a,b){return function(c){var d=a.$fire.$child("sent").$child(c.rsubject.id),e=d.$child("recipients");d.$child("date").$set((new Date).toJSON()),d.$child("subject").$set(c.rsubject),d.$child("type").$set(c.rsubject.type),c.recipients.map(function(a){return{id:a.id,name:a.name,username:a.username,relationship:a.relationship,status:"pending",date:(new Date).toJSON()}}).forEach(function(a){e.$child(a.id).$set(a)}),c.recipients.forEach(function(a){var d=b(a.id);d.info||d.child("info").set({id:a.id,name:a.name,username:a.username}),d.child("received").child(c.rsubject.id).set({subject:c.rsubject,sender:c.currentUserInfo,status:"pending"})})}}]),angular.module("myappApp").factory("FbServices",["$q",function(a){return{requestMsg:function(b,c){var d=a.defer(),e=d.promise;return FB.ui({method:"send",to:b,link:"https://apps.facebook.com/kooboodle/?requestsubject="+c},function(a){console.log("[FbServices.requestMsg] resolved",a);var b=a&&a.success?"success":"error";d.resolve({status:b,msg:""})}),e}}}]);